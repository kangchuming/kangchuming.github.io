# TCP 协议详解

## 一、连接管理

### 1. 三次握手（建立连接）
- **过程**：
  1. SYN：客户端发送 SYN=1, Seq=x
  2. SYN-ACK：服务器回复 SYN=1, ACK=1, Seq=y, Ack=x+1
  3. ACK：客户端发送 ACK=1, Seq=x+1, Ack=y+1

- **目的**：
  - 协商初始序列号
  - 确认双方通信能力

- **状态变化**：
  - 客户端：CLOSED → SYN_SENT → ESTABLISHED
  - 服务器：LISTEN → SYN_RCVD → ESTABLISHED

### 2. 四次挥手（释放连接）
- **过程**：
  1. FIN：主动关闭方发送 FIN=1, Seq=u
  2. ACK：被动关闭方回复 ACK=1, Ack=u+1
  3. FIN：被动关闭方发送 FIN=1, Seq=v
  4. ACK：主动关闭方回复 ACK=1, Ack=v+1

- **为什么需要四次**：
  - TCP 是全双工的
  - 需要独立关闭两个方向

- **关键状态**：
  - TIME_WAIT：主动关闭方等待 2MSL
    - 确保最后一个 ACK 到达
    - 防止旧报文干扰新连接
  - CLOSE_WAIT：被动关闭方等待应用层处理完剩余数据

## 二、可靠传输机制

### 1. 确认应答（ACK）
- 每个数据包都有唯一序列号
- 接收方回复 Ack=期望的下一个 Seq

### 2. 超时重传
- 动态计算 RTT（往返时间）
- 超时未收到 ACK 则重传

### 3. 滑动窗口
- 允许发送方连续发送多个包
- 窗口大小由接收方动态通知
- 无需逐条等待 ACK

### 4. 流量控制
- 接收方通过窗口大小限制发送速率
- 防止缓冲区溢出

### 5. 拥塞控制
- **慢启动**：
  - 窗口从 1 开始
  - 指数增长（cwnd *= 2）

- **拥塞避免**：
  - 达到阈值后
  - 线性增长（cwnd += 1）

- **快速重传**：
  - 收到 3 个重复 ACK
  - 立即重传（无需等待超时）

- **快速恢复**：
  - 阈值设为当前拥塞窗口的一半
  - 窗口从新阈值开始增长

## 三、通俗解释

### 1. 三次握手
- "请问在吗？"
- "在的，你呢？"
- "好的！"

### 2. 四次挥手
- "我说完了"
- "收到"
- "我也说完了"
- "收到"

### 3. 拥塞控制
- 慢启动：油门踩到底
- 拥塞避免：轻踩油门
- 快速重传：紧急刹车
- 快速恢复：重新加速

## 四、最佳实践

### 1. 连接管理
- 合理设置 TIME_WAIT 时间
- 及时处理 CLOSE_WAIT 状态
- 避免连接泄漏

### 2. 性能优化
- 调整窗口大小
- 优化重传策略
- 合理设置超时时间

### 3. 问题排查
- 关注连接状态变化
- 监控重传率
- 分析拥塞控制参数